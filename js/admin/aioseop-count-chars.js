/**
 * Counts characters of the title and description fields.
 *
 * @since 2.9.2
 * @since 3.2.0 Moved to its own file.
 * @since 3.3.0 Refactored to fix bugs.
 */

let extraTitleLength = +characterCounter.extraTitleLength;

$(function () {
	let inputField;
	let cntField;
	let fieldSize;

	aioseopInitCountChars();
	//aioseopCountChars(); // Fire once on page load.

	/**
	 * Adds the event listener to all elements with .aioseop_count_chars class.
	 *
	 * @since ?
	 * @since 3.3.0 Refactored.
	 * 
	 * @return void
	 */
	function aioseopInitCountChars() {
		$('.aioseop_count_chars').on('keyup', function () {
			inputField = $(this);
			cntField = $(this).parent().find('[name="' + $(this).attr('data-length-field') + '"]')
			aioseopCountChars();
		});
	}

	/**
	 * Counts the characters of a certain field and displays this on the front-end.
	 * 
	 *
	 * @since 1.0.0
	 * @since 2.9.1 Fix JS conflict with LearnDash and function name.
	 * @since 3.3.0 Refactored.
	 *
	 * @return void
	 */
	function aioseopCountChars() {
		let extra = 0;

		if (aioseopCheckIfAutogenerated()) {
			return;
		}

		if (('aiosp_title' === inputField.attr('name')) && ('undefined' !== typeof extraTitleLength)) {
			extra = extraTitleLength;
		}

		cntField.val(+inputField.val().length + extra);

		if ('undefined' !== typeof inputField.attr('size')) {
			fieldSize = +inputField.attr('size');
		} else {
			fieldSize = +inputField.attr('rows') * +inputField.attr('cols');
		}

		aioseopChangeCountBackground();
	}

	/**
	 * Checks if the title or description is autogenerated and, if so, counts the characters of the preview snippet.
	 * 
	 * @since 3.3.0
	 * 
	 * @return bool Whether or not the title/description is autogenerated.
	 */
	function aioseopCheckIfAutogenerated() {
		if (0 !== +inputField.val().length) {
			return false;
		}
		if ('aiosp_title' === inputField.attr('name')) {
			cntField.val(+$('#aiosp_snippet_title').parent()[0].innerText.length);
		}
		else {
			cntField.val(+$('[name=aiosp_description]')[0].placeholder.length);
		}

		return true;
	}

	/**
	 * Changes the background colour of the character counter field based on the amount of characters.
	 * 
	 * @since 3.3.0
	 * 
	 * @return void
	 */
	function aioseopChangeCountBackground() {

		if (+cntField.val() > +fieldSize) {
			cntField.removeClass().addClass('aioseop_count_chars_past_treshold');
		}

		else if (('aiosp_title' === inputField.attr('name')) || ('aiosp_home_title' === inputField.attr('name'))) {
			if (+cntField.val() > (+fieldSize - 6)) {
				cntField.removeClass().addClass('aioseop_count_chars_near_treshold');
			} else {
				cntField.removeClass().addClass('aioseop_count_chars_below_treshold');
			}
		}

		else {
			if (+cntField.val() > (+fieldSize - 10)) {
				cntField.removeClass().addClass('aioseop_count_chars_near_treshold');
			} else {
				cntField.removeClass().addClass('aioseop_count_chars_below_treshold');
			}
		}
	}

});

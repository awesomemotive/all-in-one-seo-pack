/**
 * Counts characters of the title and description fields.
 *
 * @since 2.9.2
 * @since 3.2.0 Moved to its own file.
 * @since 3.3.0 Refactored to fix bugs.
 */

var extraTitleLength = +characterCounter.extraTitleLength;

$(function () {
	var inputField;
	var cntField;
	var fieldSize;

	aioseopInitCountChars();
	//aioseopCountChars(); // Fire once on page load.

	/**
	 * Adds the event listener to all elements with .aioseop_count_chars class.
	 *
	 * @since ?
	 * @since 3.3.0 Refactored.
	 * 
	 * @return void
	 */
	function aioseopInitCountChars() {
		$('.aioseop_count_chars').on('keyup', function () {
			inputField = $(this);
			cntField = $(this).parent().find('[name="' + $(this).attr('data-length-field') + '"]');
			aioseopCountChars();
		});

		$('.aioseop_count_chars').trigger('keyup');
	}

	/**
	 * Counts the characters of a certain field and displays this on the front-end.
	 * 
	 *
	 * @since 1.0.0
	 * @since 2.9.1 Fix JS conflict with LearnDash and function name.
	 * @since 3.3.0 Refactored.
	 *
	 * @return void
	 */
	function aioseopCountChars() {
		var extra = 0;

		if (aioseopCheckIfAutogenerated()) {
			return;
		}

		if (('aiosp_title' === inputField.attr('name')) && ('undefined' !== typeof extraTitleLength)) {
			extra = extraTitleLength;
		}

		cntField.val(+inputField.val().length + extra);

		if ('undefined' !== typeof inputField.attr('size')) {
			fieldSize = +inputField.attr('size');
		} else {
			fieldSize = +inputField.attr('rows') * +inputField.attr('cols');
		}

		aioseopChangeCountBackground();
	}

	/**
	 * Checks if the title or description is autogenerated and, if so, counts the characters of the preview snippet.
	 * 
	 * @since 3.3.0
	 * 
	 * @return bool Whether or not the title/description is autogenerated.
	 */
	function aioseopCheckIfAutogenerated() {
		if (0 !== +inputField.length) {
			return false;
		}

		if (0 !== +inputField.val().length) {
			return false;
		}

		switch (inputField.attr('name')) {
			case 'aiosp_title':
			case 'aioseop_opengraph_settings_title':
				cntField.val(+$('#aiosp_snippet_title').parent()[0].innerText.length);
				break;
			default:
				cntField.val(+$('[name=aiosp_description]')[0].placeholder.length);
				break;
		}

		return true;
	}

	/**
	 * Changes the background colour of the character counter field based on the amount of characters.
	 * 
	 * @since 3.3.0
	 * 
	 * @return void
	 */
	function aioseopChangeCountBackground() {

		if (+cntField.val() > +fieldSize) {
			cntField.removeClass().addClass('aioseop_count_chars_past_treshold');
			return;
		}

		switch (inputField.attr('name')) {
			case 'aiosp_title':
			case 'aiosp_home_title':
				aioseopChangeCountBackgroundHelper(6);
				break;
			case 'aioseop_opengraph_settings_title':
			case 'aiosp_opengraph_hometitle':
				aioseopChangeCountBackgroundHelper(40);
				break;
			case 'aioseop_opengraph_settings_desc':
			case 'aiosp_opengraph_description':
				aioseopChangeCountBackgroundHelper(145);
				break;
			default:
				aioseopChangeCountBackgroundHelper(10);
				break;
		}
	}

	/**
	 * Helper function for aioseopChangeCountBackground().
	 * 
	 * @since 3.3.0
	 * 
	 * @param int characterTreshold The amount of characters that have to be deducted from the field size to set the treshold.
	 * @return void
	 */
	function aioseopChangeCountBackgroundHelper(characterTreshold) {
		if (+cntField.val() > (+fieldSize - characterTreshold)) {
			cntField.removeClass().addClass('aioseop_count_chars_near_treshold');
		} else {
			cntField.removeClass().addClass('aioseop_count_chars_below_treshold');
		}
	}

});
